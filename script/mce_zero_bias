#!/bin/bash 

# initialise environment
eval `${MAS_CONFIG:-/usr/mce/bin/mas_config} -s`

source $MAS_SCRIPT/mas_library.bash

expt=$($MAS_CONFIG --experiment-file)

# This first command prints the bias levels and also checks that MCE
# is responding
echo -n "Reading TES biases: "
command_reply rb tes bias
if [ "$?" != "0" ]; then
    echo "Aborting!"
    exit 1
fi

n_columns=`command_reply rb sq2 bias | wc -w`
n_tes_bias=`command_reply rb tes bias | wc -w`

rc_flags=( `mas_param -s $expt get hardware_rc` )

# Test whether we have a bias card for SQ2,
# or a "biasing address card"
sq2_bac=0
mce_cmd -qx rb sq2 fb 2>&1 > /dev/null || sq2_bac=1

# Funny 'if' is so we can pipe output into mce_cmd. Don't issue mce
# commands inside this block!
if [ "x" == "x" ]; then

    repeat_string "0" 41 "wb ac on_bias"
    repeat_string "0" 41 "wb ac off_bias"
    echo "wb ac enbl_mux 1"

    if [ "$sq2_bac" == "0" ]; then
        # standard BC
        repeat_string "0" $n_columns "wb sq2 fb"
    else
        # using a BAC, so we have many SQ2 fb's to zero out
        for col in `seq 0 $(( $n_columns - 1 ))`; do
	    repeat_string "0" 41 "wb sq2 fb_col$col"
	done
    fi

    repeat_string "0" $n_columns "wb sq2 bias"
    repeat_string "0" $n_columns "wb sa fb"
    repeat_string "0" $n_columns "wb sa bias"
    repeat_string "0" $n_columns "wb sa offset"
    
    repeat_string "0" $n_tes_bias "wb tes bias"
    
    # Short wait and then turn off multi-plexing
    echo "sleep 200000"
    echo "wb ac enbl_mux 0"

    # Put ADC offset to zero or you can get MSB noise
    for rc in 1 2 3 4; do
	if [ "${rc_flags[$(( $rc - 1 ))]}" != "0" ]; then
	    for c in `seq 0 7`; do
		repeat_string "0" 41 "wb rc$rc adc_offset$c"
	    done
	fi
    done
    
    # This sets sq1 feedback to constant; -8192 is 0 volts
    echo "wb rca servo_mode 0 0 0 0 0 0 0 0"
    echo "wb rca fb_const -8192 -8192 -8192 -8192 -8192 -8192 -8192 -8192"
    echo "wb rca flx_lp_init 1"
fi | mce_cmd -q

if [ "${PIPESTATUS[1]}" != "0" ]; then
    echo "FAILURE: mce_zero_bias failed!"
    echo $ERRPREF "mce_zero_bias batch file failed!" |$LOGGER
    exit 1
fi

echo -n "SA biases:  "
command_reply rb sa bias
echo -n "SQ2 biases: "
command_reply rb sq2 bias
echo -n "TES biases: "
command_reply rb tes bias
