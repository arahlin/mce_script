#!/bin/bash 

source $MAS_SCRIPT/mas_library.bash

# This first command prints the bias levels and also checks that MCE
# is responding
echo -n "Reading TES biases: "
command_reply rb tes bias
if [ "$?" != "0" ]; then
    echo "Aborting!"
    exit 1
fi

# Funny 'if' is so we can pipe output into mce_cmd.
if [ "x" == "x" ]; then

    repeat_string "0" 41 "wb ac on_bias"
    repeat_string "0" 41 "wb ac off_bias"
    echo "wb ac enbl_mux 1"
    
    n_columns=`command_reply rb sq2 fb | wc -w`
    repeat_string "0" $n_columns "wb sq2 fb"
    repeat_string "0" $n_columns "wb sq2 bias"
    repeat_string "0" $n_columns "wb sa fb"
    repeat_string "0" $n_columns "wb sa bias"
    repeat_string "0" $n_columns "wb sa offset"
    
    n_tes_bias=`command_reply rb tes bias | wc -w`
    repeat_string "0" $n_tes_bias "wb tes bias"
    
    # Short wait and then turn off multi-plexing
    echo "sleep 200000"
    echo "wb ac enbl_mux 0"
    
    # This sets sq1 feedback to constant; -8192 is 0 volts
    echo "wb rca servo_mode 0 0 0 0 0 0 0 0"
    echo "wb rca fb_const -8192 -8192 -8192 -8192 -8192 -8192 -8192 -8192"
    echo "wb rca flx_lp_init 1"
fi | mce_cmd -q

if [ "${PIPESTATUS[1]}" != "0" ]; then
    echo "FAILURE: mce_zero_bias failed!"
    echo $ERRPREF "mce_zero_bias batch file failed!" |$LOGGER
    exit 1
fi

echo -n "SA biases:  "
command_reply rb sa bias
echo -n "SQ2 biases: "
command_reply rb sq2 bias
echo -n "TES biases: "
command_reply rb tes bias
